<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d47a1">
    <title>Di√°rio de Bordo - E. M. Sobral Pinto</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#0d47a1">

    <style>
        :root { --blue: #0d47a1; --gold: #ffd600; --glass: rgba(255, 255, 255, 0.95); }
    body { font-family: 'Segoe UI', sans-serif; margin: 0; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1497633762265-9d179a990aa6?q=80') center/cover fixed; min-height: 100vh; }
        
        #status-bar { width: 100%; padding: 10px; text-align: center; font-size: 14px; font-weight: bold; color: white; position: sticky; top: 0; z-index: 10001; transition: background 0.5s ease; display: none; }
        header { background: var(--blue); color: white; padding: 15px 3%; display: flex; align-items: center; justify-content: space-between; border-bottom: 4px solid var(--gold); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .img-topo { width: 80px; height: 80px; object-fit: contain; background: white; border-radius: 50%; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .escola-txt { text-align: center; flex-grow: 1; padding: 0 15px; }
        .escola-txt h1 { margin: 0; font-size: 20px; text-transform: uppercase; }
        .escola-txt p { margin: 5px 0 0; font-size: 12px; opacity: 0.9; line-height: 1.4; }
        .container { max-width: 650px; margin: 20px auto; padding: 15px; }
        .tabs { display: flex; background: rgba(255,255,255,0.2); border-radius: 12px 12px 0 0; backdrop-filter: blur(10px); padding: 5px 5px 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: white; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0; }
        .tab-btn.active { background: var(--glass); color: var(--blue); }
        .card { background: var(--glass); padding: 25px; border-radius: 0 0 12px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .hidden { display: none !important; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
        input, select, textarea, .btn-main { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        .btn-main { background: var(--blue); color: white; font-weight: bold; cursor: pointer; border: none; padding: 12px; border-radius: 8px; width: 100%; transition: 0.3s; }
        
        .auth-wrapper { display: flex; justify-content: center; align-items: center; min-height: 70vh; padding: 20px; }
        .box-auth { background: var(--glass); padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); width: 100%; max-width: 350px; text-align: center; backdrop-filter: blur(10px); }
        .box-auth input { margin-bottom: 15px; border: 1px solid #ddd; width: 100%; }
        
        .filtro-item { display: flex; align-items: center; cursor: pointer; font-size: 14px; margin-bottom: 12px; padding: 5px; border-radius: 4px; transition: background 0.2s; }
        .filtro-item input { width: 20px; height: 20px; margin: 0 12px 0 0; cursor: pointer; flex-shrink: 0; }
        
        /* Classes do Sistema Original */
.dashboard-title { 
    font-size: 14px; 
    font-weight: bold; 
    color: var(--blue); 
    border-left: 4px solid var(--gold); 
    padding-left: 8px; 
    margin: 25px 0 10px; 
    text-transform: uppercase;
}

.pie-charts-wrapper { display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px; margin-bottom: 20px; }
.pie-container { flex: 1; min-width: 280px; display: flex; flex-direction: column; align-items: center; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

.pie-legend { font-size: 11px; list-style: none; padding: 0; width: 100%; margin-top: 10px; }
.pie-legend li { display: flex; align-items: center; margin-bottom: 6px; justify-content: space-between; border-bottom: 1px solid #f0f0f0; padding-bottom: 2px; }
.dot { width: 12px; height: 12px; border-radius: 3px; margin-right: 8px; display: inline-block; }

.column-chart-container { 
    display: flex; 
    align-items: flex-end; 
    justify-content: space-around; 
    height: 180px; 
    padding: 20px 10px; 
    border-bottom: 2px solid #ddd; 
    margin-bottom: 30px; 
    background: rgba(255,255,255,0.6); 
    border-radius: 8px; 
}
/* Garante que o c√≠rculo da pizza apare√ßa */
.pie-chart { 
    width: 150px; 
    height: 150px; 
    border-radius: 50%; 
    margin: 15px auto; 
    border: 2px solid #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    background: #f0f0f0; /* Cor de fundo caso o gradiente falhe */
}

/* Garante que as colunas apare√ßam */
.column-bar { 
    background-color: #0d47a1 !important; /* For√ßa a cor azul */
    width: 25px; 
    border-radius: 4px 4px 0 0; 
    transition: height 0.5s ease; 
    min-height: 2px; /* Garante visibilidade mesmo com 1 registro */
    display: block;
    cursor: pointer;
    transition: background-color 0.3s, height 0.5s ease;
}

.column-bar:hover {
    background-color: var(--gold) !important;
}

.lista-detalhe-turma {
    background: white;
    margin-top: 10px;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
        
.column-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end; /* Alinha as barras na base */
    height: 100%;
    flex: 1;
}
        .column-value { font-size: 11px; font-weight: bold; color: var(--blue); margin-bottom: 4px; }
.column-label { font-size: 10px; font-weight: bold; color: #333; margin-top: 8px; transform: rotate(-45deg); width: 30px; text-align: right; white-space: nowrap; }
        
        .titulo-trimestre { background: var(--gold); color: #000; padding: 8px 15px; margin-top: 25px; border-radius: 6px; font-weight: bold; border-left: 10px solid var(--blue); }
        .item-ocorrencia { background: white; padding: 15px; border-left: 5px solid var(--blue); margin-top: 10px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        /* Bot√£o flutuante no canto inferior direito */
.btn-ajuda-fixo {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: #0d47a1;
    color: white;
    border: none;
    border-radius: 30px;
    padding: 10px 20px;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    z-index: 1001;
}

/* Modal de Ajuda */
.modal-ajuda {
    position: fixed;
    bottom: 70px;
    right: 20px;
    width: 300px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    padding: 15px;
    z-index: 1000;
    border: 1px solid #ddd;
}

.hidden { display: none; }
    
    @media print {
    /* 1. Configura√ß√µes gerais de cor e fundo */
    body { 
        -webkit-print-color-adjust: exact !important; 
        print-color-adjust: exact !important; 
        background: white !important; 
    }

    /* 2. ESCONDE TUDO O QUE N√ÉO √â CABE√áALHO OU HIST√ìRICO */
    /* Isso inclui abas, bot√µes, selects, checkboxes e o bot√£o Sair */
    .tabs, 
    .btn-main, 
    .btn-ajuda-fixo, 
    #aba2 select, 
    #aba2 .filtro-box, 
    #aba2 button,
    .btn-olho { 
        display: none !important; 
    }

    /* 3. Ajusta o container para ocupar a folha inteira */
    .container { 
        max-width: 100% !important; 
        margin: 0 !important; 
        padding: 0 !important; 
    }

    .card { 
        box-shadow: none !important; 
        background: white !important; 
        border: none !important;
        padding: 0 !important;
    }

    /* 4. Melhora a apar√™ncia do hist√≥rico impresso */
    .item-ocorrencia { 
        border: 1px solid #eee !important; 
        page-break-inside: avoid; 
        margin-bottom: 15px !important;
        padding: 10px !important;
    }

    /* Garante que o cabe√ßalho da escola apare√ßa no topo */
    header {
        display: flex !important;
        background: white !important;
        color: black !important;
        border-bottom: 2px solid #0d47a1 !important;
        margin-bottom: 20px !important;
    }
    
    .escola-txt h1 { color: #0d47a1 !important; }
}
    
    </style>
</head>

<body>

<div id="status-bar">Aguardando status da rede...</div>

<header>
    <img src="https://lh3.googleusercontent.com/u/0/d/16JafsMd81Ho26kkaqCI-YTvsCGIXQ2Fy" alt="Perfil" class="img-topo" id="imgPerfil">
    <div class="escola-txt">
        <h1>Escola Municipal Sobral Pinto</h1>
        <p>Rua das Almas, 120 - Conjunto Paulo VI, Belo Horizonte - MG.<br>CEP: 31998-020</p>
    </div>
</header>

<div id="secaoAcesso" class="auth-wrapper">
    <div id="telaLogin" class="box-auth">
        <h2 style="color:var(--blue)">üîí Login</h2>
        <input type="text" id="userLogin" placeholder="Usu√°rio">
        <div class="senha-container" style="position:relative;">
            <input type="password" id="passLogin" placeholder="Senha">
            <button type="button" class="btn-olho" style="position:absolute; right:10px; top:12px; border:none; background:none; cursor:pointer;" onclick="toggleSenha('passLogin', 'iconeOlho')">
                <span id="iconeOlho">üëÅÔ∏è</span>
            </button>
        </div>
        <button class="btn-main" id="btnEntrar" onclick="executarLogin()">Entrar</button>
        <button style="background:none; border:none; color:var(--blue); cursor:pointer; margin-top:10px;" onclick="irPara('telaRecuperar')">Alterar senha</button>
    </div>



    
    <div id="telaRecuperar" class="box-auth hidden">
        <h2 style="color:var(--blue)">üîë Recuperar</h2>
        <input type="text" id="recNome" placeholder="Nome Completo">
        <input type="text" id="recBM" placeholder="BM">
        <input type="password" id="recNovaPass" placeholder="Nova Senha">
        <button class="btn-main" onclick="executarRecuperacao()">Alterar Senha</button>
        <button style="background:none; border:none; color:var(--blue); cursor:pointer; margin-top:10px;" onclick="irPara('telaLogin')">Voltar</button>
    </div>
</div>

<div id="conteudoDiario" class="container hidden">
    <div class="tabs">
        <button id="t1" class="tab-btn active" onclick="tab(1)">üìù INCLUIR</button>
        <button id="t2" class="tab-btn" onclick="tab(2)">üîç CONSULTAR</button>
        <button id="t3" class="tab-btn" onclick="tab(3)">üìä ALERTAS</button>
        <button id="t4" class="tab-btn hidden" onclick="tab(4)">üë• CADASTRO</button>                                                          
        <button onclick="logout()" style="background:none; color:white; flex:0.3; cursor:pointer">Sair</button>
    </div>
    <div class="card">
        <div id="aba1">
            <div id="tipoRegistroContainer" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                <label style="margin-top:0;">Tipo de Registro:</label>
                <select id="selTipoRegistro" onchange="ajustarCamposRegistro()">
                    <option value="üìù Ocorr√™ncia Disciplinar">üìù Ocorr√™ncia Disciplinar</option>
                    <option value="üìö Ocorr√™ncia Pedag√≥gica">üìö Ocorr√™ncia Pedag√≥gica</option>
                    <option value="üë™ Reuni√£o com a Fam√≠lia">üë™ Reuni√£o com a Fam√≠lia</option>
                    <option value="üè• Sa√∫de (Doente / Machucou)">üè• Sa√∫de (Doente / Machucou)</option>
                    <option value="üß† Equipe PAS">üß† Equipe PAS</option>
                    <option value="‚ôø Atendimento AEE">‚ôø Atendimento AEE</option>
                    <option value="üìé Outros Atendimentos">üìé Outros Atendimentos</option>
                </select>
            </div>
            <label>Respons√°vel:</label>
            <input type="text" id="nomeProfLogado" readonly style="background:#e9ecef">
            <label>Data:</label>
            <input type="date" id="dataOcorrenciaManual">
            <label>Turma:</label>
            <select id="selTurma" onchange="atualizarAlunos('selTurma', 'selAluno')"><option value="">Carregando...</option></select>
            <label>Aluno:</label>
            <select id="selAluno"><option value="">Selecione a turma...</option></select>
            
            <div id="boxAdvertencia">
                <label style="display: flex; align-items: center; cursor: pointer; background: #fff3cd; padding: 10px; border-radius: 8px; border: 1px solid #ffeeba; margin-top: 15px;">
                    <input type="checkbox" id="chkAdvertencia" style="width: auto; margin: 0 10px 0 0;"> 
                    <span>Foi enviada Advert√™ncia por Escrito?</span>
                </label>
            </div>

            <label id="labelRelato">Relato do Professor:</label>
            <textarea id="relatoTexto" rows="5"></textarea>
            <div id="containerTratativa"></div>
            <button class="btn-main" id="btnGravar" onclick="gravarOcorrencia()">Gravar no Di√°rio</button>
        </div>

        <div id="aba2" class="hidden">
            <select id="selTurmaCons" onchange="atualizarAlunos('selTurmaCons', 'selAlunoCons')"><option value="">Turma...</option></select>
            <select id="selAlunoCons" style="margin-top:10px;"><option value="">Aluno...</option></select>
            <select id="selPeriodoCons" style="margin-top:10px;">
                <option value="Todos os Trimestres">Todos os Trimestres</option>
                <option value="1¬∫ Trimestre">1¬∫ Trimestre</option>
                <option value="2¬∫ Trimestre">2¬∫ Trimestre</option>
                <option value="3¬∫ Trimestre">3¬∫ Trimestre</option>
            </select>
            <div class="filtro-box">
                <label class="filtro-item"><input type="checkbox" id="chkMeusRegistros" checked onclick="alternarCheckboxes('meu')"> <span>Apenas meus registros</span></label>
                <label class="filtro-item"><input type="checkbox" id="chkTodosRegistros" onclick="alternarCheckboxes('todos')"> <span>Todas as ocorr√™ncias</span></label>
            </div>
            <button class="btn-main" onclick="consultarHistorico()">üîç Buscar Hist√≥rico</button>
            <div id="resConsulta"></div>
            <button class="btn-main" id="btnImp" style="background:#444; display:none; margin-top:20px" onclick="window.print()">üñ®Ô∏è PDF / Imprimir</button>
        </div>

        <div id="aba3" class="hidden">
    <h2 style="color:var(--blue); margin-top:0;">üìä Controle Geral de Ocorr√™ncias</h2>
    <button class="btn-main" onclick="gerarAlertaCritico()">üîÑ Atualizar ocorr√™ncias</button>
    
    <div id="resDashboard" class="hidden">
        <div class="dashboard-title">Alunos Cr√≠ticos (+10 ocorr√™ncias)</div>
        <div id="resAlertaCritico"></div>

        <div class="dashboard-title">Ocorr√™ncias por Turma</div>
        <div id="graficoTurmas"></div>
        <div id="detalheAlunosTurma" class="hidden lista-detalhe-turma"></div>

        <div class="dashboard-title">Alunos com mais ocorr√™ncias</div>
        <div id="listaAlunosMaisOcorrencias" style="margin-bottom:20px;"></div>

        <div class="dashboard-title">Ocorr√™ncias (Geral)</div>
        <div class="pie-charts-wrapper">
            <div id="graficoPizzaTipos" class="pie-container"></div>
            <div id="graficoPizzaTratativas" class="pie-container"></div>
        </div>
    </div>
</div>

        <div id="aba4" class="hidden">
            <div class="card" style="border-left: 5px solid var(--blue); margin-bottom: 20px;">
                <h3 style="color:var(--blue); margin-top:0;">‚ûï Cadastrar Novo Aluno</h3>
                <input type="text" id="novoAlunoNome" placeholder="Nome Completo do Aluno">
                <label>Selecione a Turma:</label>
                <select id="novoAlunoTurma"></select>
                <button class="btn-main" onclick="salvarNovoAluno()">Cadastrar Aluno</button>
            </div>

            <div class="card" style="border-left: 5px solid orange;">
    <h3 style="color:orange; margin-top:0;">üîÑ Transferir Aluno</h3>
    
    <label>1. Origem (Turma Atual):</label>
    <select id="selTurmaTransf" onchange="atualizarAlunos('selTurmaTransf', 'selectAlunoTransferir')">
        <option value="">Selecione a turma...</option>
    </select>

    <label>2. Aluno para mover:</label>
    <select id="selectAlunoTransferir">
        <option value="">Selecione a turma primeiro...</option>
    </select>

    <label>3. Destino (Nova Turma):</label>
    <select id="novaTurmaDestino"></select>
    
    <button class="btn-main" style="background:orange; margin-top:15px;" onclick="transferirAluno()">Confirmar Mudan√ßa de Sala</button>
</div>
        </div>
    </div>
</div>


    <button class="btn-ajuda-fixo" onclick="toggleAjuda()">üí° D√∫vidas ou sugest√µes?</button>

<div id="caixaAjuda" class="modal-ajuda hidden">
    <h3 style="margin-top:0; color:#0d47a1; font-size:16px;">Suporte T√©cnico</h3>
    
    <div style="text-align:left; font-size:11px; margin-bottom:10px; color:#444; background:#f5f5f5; padding:8px; border-radius:8px;">
        <strong>Escola:</strong> <span id="infoEscolaSuporte"></span><br>
        <strong>Professor(a):</strong> <span id="infoProfSuporte"></span>
    </div>

    <textarea id="textoDuvida" rows="4" placeholder="Descreva sua d√∫vida ou sugest√£o aqui..." style="width:100%; border:1px solid #ccc; border-radius:6px; padding:8px; font-size:13px; box-sizing:border-box;"></textarea>
    
    <button class="btn-main" style="background:#25d366; color:white; border:none; width:100%; margin-top:10px; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;" onclick="enviarWhatsApp()">
        üöÄ Enviar via WhatsApp
    </button>
</div>
    
<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlVbz3C-bdKUbRvuWx4SrL9eiFdmyRwwZwUYVhi9u8u2df9NSgNRNjsYx7gD5q1qef7g/exec";
    let ALUNOS = {};
    let cargoLogado = "", profNomeLogado = "", disciplinaLogada = "", idEditando = null;

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').then(reg => console.log('SW OK'), err => console.log('Erro SW'));
        });
    }

    window.onload = function() {
    window.NOME_ESCOLA = "E. M. Sobral Pinto"; // [cite: 2]
    
    // Tenta carregar do cache imediatamente para n√£o ficar vazio
    const cacheAlunos = localStorage.getItem('cache_alunos_sobral');
    if (cacheAlunos) { 
        ALUNOS = JSON.parse(cacheAlunos); 
        popularTurmas(); 
    }

    // Tenta atualizar do servidor
    if (navigator.onLine) { 
        carregarDadosIniciais(); 
    }
    
    atualizarStatusRede();
};

    function toggleAjuda() {
    const caixa = document.getElementById('caixaAjuda');
    caixa.classList.toggle('hidden');
    
    // Atualiza as informa√ß√µes de suporte caso o professor j√° tenha logado
    if (!caixa.classList.contains('hidden')) {
        document.getElementById('infoEscolaSuporte').innerText = "E. M. Sobral Pinto";
        document.getElementById('infoProfSuporte').innerText = profNomeLogado || "N√£o logado";
    }
}

    function enviarWhatsApp() {
    const duvida = document.getElementById('textoDuvida').value.trim();
    if (!duvida) {
        alert("Por favor, digite sua d√∫vida antes de enviar.");
        return;
    }

    const nomeProfessor = typeof profNomeLogado !== 'undefined' ? profNomeLogado : "N√£o identificado";
    const escola = typeof NOME_ESCOLA !== 'undefined' ? NOME_ESCOLA : "E. M. Sobral Pinto";
    
    // O layout que voc√™ solicitou
    const msg = `*Suporte Di√°rio de Bordo*\n` +
                `*Escola:* ${escola}\n` +
                `*Professor(a):* ${nomeProfessor}\n` +
                `*D√∫vida/Sugest√£o:* ${duvida}`;

    const numeroSuporte = "5531975580836";
    const url = `https://api.whatsapp.com/send?phone=${numeroSuporte}&text=${encodeURIComponent(msg)}`;
    
    window.open(url, '_blank');
}
    
    function atualizarStatusRede() {
        const barra = document.getElementById('status-bar');
        if (navigator.onLine) {
            barra.textContent = "‚úÖ Voc√™ est√° Online";
            barra.style.background = "#4caf50";
            barra.style.display = "block";
            sincronizarDados();
            setTimeout(() => barra.style.display = "none", 3000);
        } else {
            barra.textContent = "‚ö†Ô∏è Offline. Registros salvos no celular.";
            barra.style.background = "#ff9800";
            barra.style.display = "block";
        }
    }

    function alternarCheckboxes(quem) {
    const cMeu = document.getElementById('chkMeusRegistros');
    const cTodos = document.getElementById('chkTodosRegistros');

    if (quem === 'meu') {
        // Se marcou "Meus", desmarca o "Todos"
        if (cMeu.checked) {
            cTodos.checked = false;
        } else {
            // Impede desmarcar os dois: se tentou desmarcar "Meus", ele volta a marcar
            cMeu.checked = true;
        }
    } else if (quem === 'todos') {
        // Se marcou "Todos", desmarca o "Meus"
        if (cTodos.checked) {
            cMeu.checked = false;
        } else {
            // Impede desmarcar os dois
            cTodos.checked = true;
        }
    }

    // Se houver uma consulta ativa na tela, atualiza os resultados automaticamente
    if (document.getElementById('resConsulta').innerHTML !== "" && 
        document.getElementById('resConsulta').innerHTML !== "Buscando...") {
        consultarHistorico();
    }
}
    
    window.addEventListener('online', atualizarStatusRede);
    window.addEventListener('offline', atualizarStatusRede);

    async function executarLogin() {
        const u = document.getElementById('userLogin').value, s = document.getElementById('passLogin').value;
        const btn = document.getElementById('btnEntrar');
        btn.innerText = "‚è≥...";
        try {
            const res = await fetch(`${SCRIPT_URL}?acao=login&usuario=${u}&senha=${s}`);
            const d = await res.json();
            if(d.status === "Autorizado") {
                localStorage.setItem('diarioAcessoSobral', JSON.stringify(d)); 
                aplicarLogin(d);
            } else alert("Negado.");
        } catch (e) { alert("Erro de conex√£o."); }
        btn.innerText = "Entrar";
    }

    function aplicarLogin(d) {
    profNomeLogado = d.nome;
    disciplinaLogada = d.disciplina;
    const cp = String(d.cargo).trim().toUpperCase();
    
    // Lista de cargos de gest√£o
    const gestores = ["DIRETOR", "DIRETORA", "VICE-DIRETOR", "VICE-DIRETORA", "COORDENADOR", "COORDENADORA", "SUPERVISOR", "SUPERVISORA", "PAS"];
    const ehGestao = gestores.some(c => cp.includes(c));
    const ehAEE = cp.includes("AEE");
    
cargoLogado = ehGestao ? "Diretor" : (ehAEE ? "AEE" : "Professor");

    // 2. Trava do Select de Tipos de Registro
    const selTipo = document.getElementById('selTipoRegistro');
    if (selTipo) {
        if (cargoLogado === "Professor") {
            // Se for professor comum, remove as op√ß√µes restritas
            // Mantemos apenas Disciplinar e Pedag√≥gica
            selTipo.innerHTML = `
                <option value="üìù Ocorr√™ncia Disciplinar">üìù Ocorr√™ncia Disciplinar</option>
                <option value="üìö Ocorr√™ncia Pedag√≥gica">üìö Ocorr√™ncia Pedag√≥gica</option>
            `;
        } else if (cargoLogado === "AEE") {
            // Se for Professor AEE, ele v√™ as dele + as b√°sicas se desejar
            selTipo.innerHTML = `
                <option value="‚ôø Atendimento AEE">‚ôø Atendimento AEE</option>
                <option value="üìù Ocorr√™ncia Disciplinar">üìù Ocorr√™ncia Disciplinar</option>
                <option value="üìö Ocorr√™ncia Pedag√≥gica">üìö Ocorr√™ncia Pedag√≥gica</option>
            `;
        } else {
            // Gest√£o continua vendo TUDO
            selTipo.innerHTML = `
                <option value="üìù Ocorr√™ncia Disciplinar">üìù Ocorr√™ncia Disciplinar</option>
                <option value="üìö Ocorr√™ncia Pedag√≥gica">üìö Ocorr√™ncia Pedag√≥gica</option>
                <option value="üë™ Reuni√£o com a Fam√≠lia">üë™ Reuni√£o com a Fam√≠lia</option>
                <option value="üè• Sa√∫de (Doente / Machucou)">üè• Sa√∫de (Doente / Machucou)</option>
                <option value="üß† Equipe PAS">üß† Equipe PAS</option>
                <option value="‚ôø Atendimento AEE">‚ôø Atendimento AEE</option>
                <option value="üìé Outros Atendimentos">üìé Outros Atendimentos</option>
            `;
        }
    }
    

    document.getElementById('secaoAcesso').classList.add('hidden');
    document.getElementById('conteudoDiario').classList.remove('hidden');
    document.getElementById('nomeProfLogado').value = profNomeLogado;

    // APARECER O BOT√ÉO PARA GEST√ÉO
    const btnAlunos = document.getElementById('t4');
    if (cargoLogado === "Diretor") {
        btnAlunos.classList.remove('hidden');
    } else {
        btnAlunos.classList.add('hidden');
    }

    definirDataHoje(); popularTurmas(); ajustarCamposRegistro();
}

    function popularTurmas() {
    // Adicionado 'selTurmaTransf' na lista
    const ids = ['selTurma', 'selTurmaCons', 'novoAlunoTurma', 'novaTurmaDestino', 'selTurmaTransf'];
    const turmas = Object.keys(ALUNOS).sort();
    ids.forEach(id => {
        const sel = document.getElementById(id);
        if(sel) {
            sel.innerHTML = '<option value="">Turma...</option>';
            turmas.forEach(t => sel.add(new Option(t, t)));
        }
    });
}

    function abrirAba(num) {
    // Se tentar abrir a aba 4 e n√£o for gestor, bloqueia
    if (num === 4 && cargoLogado !== "Diretor") {
        alert("Acesso restrito √† equipe de gest√£o.");
        return;
    }

    // L√≥gica normal de trocar abas...
    document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
    document.getElementById('aba' + num).classList.remove('hidden');
}

    function atualizarAlunos(idT, idA) {
        const t = document.getElementById(idT).value, s = document.getElementById(idA);
        s.innerHTML = '<option value="">-- Selecione --</option>';
        if(ALUNOS[t]) {
            s.add(new Option("üë• TODA A TURMA", "TODA A TURMA"));
            ALUNOS[t].forEach(al => s.add(new Option(al, al)));
        }
    }

    async function gravarOcorrencia() {
    const tVal = document.getElementById('selTurma').value;
    const aVal = document.getElementById('selAluno').value;
    const rVal = document.getElementById('relatoTexto').value;
    const dVal = document.getElementById('dataOcorrenciaManual').value;

    // Valida√ß√£o b√°sica de campos obrigat√≥rios
    if (!dVal || !tVal || !aVal || !rVal.trim()) {
        return alert("‚ö†Ô∏è Preencha Data, Turma, Aluno e Relato!");
    }

    let tratativaFinal = "";
    let relatoGestaoFinal = "";

    // L√ìGICA DE PRESERVA√á√ÉO E ATUALIZA√á√ÉO (Diretor vs Professor)
    if (cargoLogado === "Diretor") {
        const selT = document.getElementById('selTratativa');
        const dtC = document.getElementById('dataConvocacao');
        const rG = document.getElementById('relatoGestaoTexto');

        if (selT && selT.value) {
            tratativaFinal = selT.value;
            if (tratativaFinal === "Fam√≠lia Convocada" && dtC && dtC.value) {
                const dataFormatada = dtC.value.split('-').reverse().join('/');
                tratativaFinal += ` (Data: ${dataFormatada})`;
            }
        } else {
            tratativaFinal = window.tratativaAntiga || "";
        }
        
        relatoGestaoFinal = (rG && rG.offsetParent !== null) ? rG.value : (window.relatoGestaoAntigo || "");
    } else {
        tratativaFinal = window.tratativaAntiga || "";
        relatoGestaoFinal = window.relatoGestaoAntigo || "";
    }

    // --- L√ìGICA DE IDENTIFICA√á√ÉO PAS vs PROF ---
    let prefixo = "Prof: ";
    // Verifica se a disciplina ou o cargo cont√©m "PAS"
    if (disciplinaLogada.toUpperCase().includes("PAS") || cargoLogado.toUpperCase().includes("PAS")) {
        prefixo = "PAS: ";
    }

    // Montagem do objeto de dados para envio
    const dados = {
        acao: idEditando ? 'editarOcorrencia' : 'salvarOcorrencia',
        id: idEditando || Date.now(),
        // Formato: [Tipo] Prefixo Nome (Disciplina)
        professor: `[${document.getElementById('selTipoRegistro').value}] ${prefixo}${profNomeLogado.split(" ")[0]} (${disciplinaLogada})`,
        dataManual: dVal.split("-").reverse().join("/"),
        turma: tVal,
        aluno: aVal,
        texto: rVal,
        advertencia: document.getElementById('chkAdvertencia').checked ? "SIM" : "N√ÉO",
        tratativa: tratativaFinal,
        relatoGestao: relatoGestaoFinal
    };

    const btn = document.getElementById('btnGravar');
    const textoOriginal = btn.innerText;
    btn.innerText = "‚è≥ Gravando...";
    btn.disabled = true;

    if (navigator.onLine) {
        try {
            const p = new URLSearchParams();
            for (let key in dados) p.append(key, dados[key]);
            
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
            
            alert("‚úÖ Registro gravado com sucesso!");
            limparForm();
            if (idEditando) {
                tab(2); 
                consultarHistorico();
            }
        } catch (e) { 
            console.error("Erro ao gravar:", e);
            salvarFila(dados); 
        }
    } else {
        salvarFila(dados);
    }

    btn.innerText = textoOriginal;
    btn.disabled = false;
}

    // Converte "dd/mm/aaaa" em um n√∫mero compar√°vel
    function converterParaDataObjeto(stringData) {
        if (!stringData) return 0;
        const [dia, mes, ano] = stringData.split('/');
        return new Date(ano, mes - 1, dia).getTime();
    }
    
    function salvarFila(d) {
        let f = JSON.parse(localStorage.getItem('filaOfflineSobral') || "[]");
        f.push(d); localStorage.setItem('filaOfflineSobral', JSON.stringify(f));
        alert("Salvo offline!"); limparForm();
    }

    async function sincronizarDados() {
    // 1. Verifica se j√° existe uma sincroniza√ß√£o em andamento para evitar duplicidade
    if (window.isSyncing) return;
    
    let f = JSON.parse(localStorage.getItem('filaOfflineSobral') || "[]");
    
    if (f.length > 0 && navigator.onLine) {
        window.isSyncing = true; // Bloqueia novas tentativas simult√¢neas
        console.log("Iniciando sincroniza√ß√£o de " + f.length + " registros...");

        // 2. Criamos uma c√≥pia da fila e limpamos o localStorage IMEDIATAMENTE
        // Assim, se o usu√°rio clicar de novo, a fila j√° estar√° vazia.
        const itensParaEnviar = [...f];
        localStorage.removeItem('filaOfflineSobral');

        try {
            for (let item of itensParaEnviar) {
                const p = new URLSearchParams(); 
                for (let k in item) p.append(k, item[k]);
                
                // Usamos await para garantir que um termine antes do outro
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
            }
            alert("‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso!");
        } catch (e) {
            console.error("Erro na sincroniza√ß√£o:", e);
            // 3. Se falhar feio, devolvemos os itens n√£o enviados para a fila
            const filaAtual = JSON.parse(localStorage.getItem('filaOfflineSobral') || "[]");
            localStorage.setItem('filaOfflineSobral', JSON.stringify([...itensParaEnviar, ...filaAtual]));
            alert("‚ö†Ô∏è Falha ao sincronizar. Os dados foram preservados no aparelho.");
        } finally {
            window.isSyncing = false; // Libera o bloqueio
        }
    }
}

    async function consultarHistorico() {
    const t = document.getElementById('selTurmaCons').value, 
          a = document.getElementById('selAlunoCons').value,
          p = document.getElementById('selPeriodoCons').value;

    if (!t) return alert("Selecione a Turma.");
    
    const rDiv = document.getElementById('resConsulta'); 
    rDiv.innerHTML = "Buscando...";

    try {
        const res = await fetch(`${SCRIPT_URL}?acao=getDados`);
        let dadosPlanilha = await res.json();

        // Remove o cabe√ßalho
        dadosPlanilha.shift();

        // CHAMA A FUN√á√ÉO DE EXIBI√á√ÉO (O que faltava!)
        exibirDados(dadosPlanilha, t, a, p);

    } catch (e) {
        console.error(e);
        rDiv.innerHTML = "Erro ao carregar dados.";
    }
}

    function exibirDados(data, t, a, p) {
    const rDiv = document.getElementById('resConsulta');
    const verTodos = document.getElementById('chkTodosRegistros').checked;
    
    // 1. Filtragem por Turma e Aluno
    let filtrados = data.filter(r => {
        const turmaBate = r[3] && String(r[3]).trim() === t;
        const alunoBate = a ? (String(r[4]).trim() === a) : (String(r[4]).trim() === "TODA A TURMA");
        return turmaBate && alunoBate;
    });

    // 2. Filtros de Trimestre e Dono do Registro
    if (p !== "Todos os Trimestres") {
        filtrados = filtrados.filter(r => identificarTrimestre(r[1]) === p);
    }
    
    if (!verTodos) {
        const meuNome = profNomeLogado.split(" ")[0].toUpperCase();
        filtrados = filtrados.filter(r => String(r[2]).toUpperCase().includes(meuNome));
    }

    // 3. ORDENA√á√ÉO CRONOL√ìGICA (Mais recente primeiro)
    filtrados.sort((m, n) => {
        const converter = (dataStr) => {
            const partes = dataStr.split('/');
            // Cria o objeto Date (ano, m√™s-1, dia) para compara√ß√£o num√©rica
            return new Date(partes[2], partes[1] - 1, partes[0]).getTime();
        };
        // m - n garante a ordem ASCENDENTE (mais antiga -> mais nova)
        return converter(m[1]) - converter(n[1]);
    });

    if (filtrados.length === 0) { 
        rDiv.innerHTML = "<p style='text-align:center; padding:20px;'>Nada encontrado.</p>"; 
        return; 
    }
    
    let html = `<h3>Hist√≥rico: ${a || "Toda a Turma " + t}</h3>`;
    
    // 4. AGRUPAMENTO POR TRIMESTRE (Mantendo a ordem cronol√≥gica dentro deles)
    let grupos = { "1¬∫ Trimestre": [], "2¬∫ Trimestre": [], "3¬∫ Trimestre": [], "Fora de Per√≠odo": [] };
    
    filtrados.forEach(r => { 
        let tri = identificarTrimestre(r[1]); 
        if(grupos[tri]) grupos[tri].push(r); 
        else grupos["Fora de Per√≠odo"].push(r); 
    });

    for (let tri in grupos) {
        if (grupos[tri].length > 0) {
            html += `<div class="titulo-trimestre">${tri}</div>`;
            grupos[tri].forEach(r => {
                const souDono = String(r[2]).toUpperCase().includes(profNomeLogado.split(" ")[0].toUpperCase());
                const souGestor = (cargoLogado === "Diretor");

                let textoTratativaBruto = r[7] || "";
                let textoExibicao = textoTratativaBruto;
                let avisoDataReuniao = "";

                if (textoTratativaBruto.includes("(Data:")) {
                    const matchData = textoTratativaBruto.match(/\d{2}\/\d{2}\/\d{4}/);
                    if (matchData) {
                        avisoDataReuniao = `<p style="color:#e65100; font-weight:bold; margin-top:5px; margin-bottom:0;">üìÖ Reuni√£o agendada para: ${matchData[0]}</p>`;
                        textoExibicao = textoTratativaBruto.replace(/\s\(Data:.*?\)/g, "");
                    }
                }

                const relatoPrivadoHTML = (souGestor && r[8]) ? 
                    `<div style="background:#fff3e0; padding:10px; border:1px dashed #ff9800; margin-top:8px; font-size:12px; color:#e65100;">
                        <strong>üîí Relato Privado (Gest√£o):</strong> ${r[8]}
                    </div>` : "";

                html += `<div class="item-ocorrencia">
                    <div style="float:right; display:flex; gap:5px;">
                        ${(souDono || souGestor) ? `<button onclick="carregarParaEdicao('${r[0]}','${r[1]}','${r[3]}','${r[4]}','${r[5]}','${r[7]||""}','${r[8]||""}', false)" style="background:orange; color:white; border:none; padding:5px; border-radius:4px; cursor:pointer;">Editar</button>` : ''}
                        ${souGestor ? `
                            <button onclick="carregarParaEdicao('${r[0]}','${r[1]}','${r[3]}','${r[4]}','${r[5]}','${r[7]||""}','${r[8]||""}', true)" style="background:#1976d2; color:white; border:none; padding:5px; border-radius:4px; cursor:pointer;">Tratar</button>
                            <button onclick="apagarRegistro('${r[0]}')" style="background:red; color:white; border:none; padding:5px 8px; border-radius:4px; cursor:pointer;">X</button>
                        ` : ''}
                    </div>
                    <strong>${r[1]} - ${r[2]}</strong>
                    <p style="margin:10px 0;">${r[5]}</p>
                    ${r[6] === "SIM" ? '<p style="color:red; font-weight:bold;">‚ö†Ô∏è Advert√™ncia por Escrito Enviada</p>' : ''}
                    ${textoTratativaBruto ? `<div style="background:#e8f5e9; padding:10px; border-left:4px solid #4caf50; font-size:13px;"><strong>A√ß√£o da Gest√£o:</strong> ${textoExibicao} ${avisoDataReuniao}</div>` : ''}
                    ${relatoPrivadoHTML}
                </div>`;
            });
        }
    }
    rDiv.innerHTML = html;
    document.getElementById('btnImp').style.display = "block";
}

    function carregarParaEdicao(id, data, turma, aluno, texto, tratativa, relatoGestao, focarTratativa) {
    // ESTAS DUAS LINHAS S√ÉO A CHAVE PARA N√ÉO SUMIR:
    window.tratativaAntiga = tratativa || "";
    window.relatoGestaoAntigo = relatoGestao || "";

    idEditando = id; 
    tab(1);
    
    // Ajuste da data principal
    const p = data.split('/');
    if(p.length === 3) document.getElementById('dataOcorrenciaManual').value = `${p[2]}-${p[1]}-${p[0]}`;
    
    document.getElementById('selTurma').value = turma;
    atualizarAlunos('selTurma', 'selAluno');
    
    setTimeout(() => {
        document.getElementById('selAluno').value = aluno;
    }, 200);
    
    document.getElementById('relatoTexto').value = texto;

    const cont = document.getElementById('containerTratativa');
    
    if (cargoLogado === "Diretor" && focarTratativa === true) {
        // Extra√ß√£o precisa da data da convoca√ß√£o
        let opcaoLimpa = tratativa.split(" (Data:")[0].trim();
        let dataParaInput = "";
        
        if (tratativa.includes("(Data:")) {
            const extrair = tratativa.match(/\d{2}\/\d{2}\/\d{4}/);
            if (extrair) {
                dataParaInput = extrair[0].split('/').reverse().join('-');
            }
        }

        cont.innerHTML = `
            <div style="background:#f0f7ff; padding:15px; border-radius:8px; margin-top:15px; border:1px solid #1976d2;">
                <label style="color:#1976d2; font-weight:bold;">üõ†Ô∏è Espa√ßo da Gest√£o (Tratativa)</label>
                
                <select id="selTratativa" onchange="verificarDataConvocacao()" style="width:100%; margin-top:8px;">
                    <option value="">Selecione a a√ß√£o...</option>
                    <option value="Conversa com o Aluno">Conversa com o Aluno</option>
                    <option value="Advert√™ncia Verbal">Advert√™ncia Verbal</option>
                    <option value="Advert√™ncia por Escrito">Advert√™ncia por Escrito</option>
                    <option value="Fam√≠lia Convocada">Fam√≠lia Convocada</option>
                    <option value="Encaminhamento PAS">Encaminhamento PAS</option>
                </select>

                <div id="divDataConvocacao" style="display:none; margin-top:10px;">
                    <label>üìÖ Data da Reuni√£o:</label>
                    <input type="date" id="dataConvocacao" style="width:100%;">
                </div>

                <label style="display:block; margin-top:15px;">üîí Relato Interno (Privado):</label>
                <textarea id="relatoGestaoTexto" rows="3" style="width:100%;" placeholder="Anota√ß√µes da gest√£o..."></textarea>
            </div>`;
        
        cont.classList.remove('hidden');

        // IMPORTANTE: Atribuir valores AP√ìS criar o HTML acima
        setTimeout(() => {
            document.getElementById('selTratativa').value = opcaoLimpa;
            document.getElementById('relatoGestaoTexto').value = relatoGestao || "";
            
            if (opcaoLimpa === "Fam√≠lia Convocada") {
                document.getElementById('divDataConvocacao').style.display = 'block';
                document.getElementById('dataConvocacao').value = dataParaInput;
            }
            document.getElementById('selTratativa').focus();
        }, 50);

    } else {
        cont.innerHTML = "";
        cont.classList.add('hidden');
    }
    document.getElementById('btnGravar').innerText = "üíæ Salvar Altera√ß√£o";
}

    async function apagarRegistro(id) {
    // 1. A exclus√£o √© uma a√ß√£o cr√≠tica, por isso exige internet para atualizar o banco de dados
    if (!navigator.onLine) {
        return alert("‚ö†Ô∏è A exclus√£o de registros exige conex√£o com a internet para atualizar o banco de dados da escola.");
    }

    // 2. Confirma√ß√£o de seguran√ßa para evitar cliques acidentais
    if (!confirm("Tem certeza que deseja excluir este registro definitivamente? Esta a√ß√£o n√£o pode ser desfeita.")) {
        return;
    }

    const btn = event.target; // Captura o bot√£o clicado
    const textoOriginal = btn.innerText;
    btn.innerText = "‚è≥...";
    btn.disabled = true;

    try {
        const p = new URLSearchParams();
        p.append('acao', 'apagarOcorrencia');
        p.append('id', id);

        // Envia o pedido para o SCRIPT_URL definido no topo do c√≥digo
        const res = await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
        
        alert("Registro exclu√≠do com sucesso!");
        
        // Atualiza a lista na tela para o registro sumir imediatamente
        consultarHistorico(); 
    } catch (e) {
        console.error("Erro ao excluir:", e);
        alert("Ocorreu um erro ao tentar excluir o registro no servidor.");
        btn.innerText = textoOriginal;
        btn.disabled = false;
    }
}
    
    function verificarDataConvocacao() {
    const sel = document.getElementById('selTratativa');
    const div = document.getElementById('divDataConvocacao');
    if (sel && div) {
        div.style.display = (sel.value === "Fam√≠lia Convocada") ? "block" : "none";
    }
}

    async function gerarAlertaCritico() {
    if (!navigator.onLine) return alert("‚ö†Ô∏è Voc√™ est√° offline. Conecte-se para atualizar o Dashboard.");
    
    const dashboard = document.getElementById('resDashboard');
    dashboard.classList.remove('hidden');
    document.getElementById('resAlertaCritico').innerHTML = "‚è≥ Processando dados...";
    
    try {
        const res = await fetch(`${SCRIPT_URL}?acao=getDados`);
        const data = await res.json();

        let contAlunos = {}, contManha = {}, contTarde = {}, contTipos = {}, contTratativas = {};
        let detalheTurmas = {};
        // Lista exata das turmas do turno da tarde
        const turmasTarde = ["5¬∫C", "601", "602", "603", "701", "702", "801", "802", "901", "902"];
        const cores = ["#0d47a1", "#ffd600", "#4caf50", "#f44336", "#9c27b0", "#ff9800", "#00bcd4"];

        // 1. Processamento dos dados da Planilha (i=1 pula o cabe√ßalho)
        for (let i = 1; i < data.length; i++) {
            const profField = data[i][2] || ""; 
            const turma = data[i][3];
            const aluno = data[i][4];
            const tratativaRaw = (data[i][7] || "").split(" (")[0].trim() || "Sem a√ß√£o da gest√£o";

            // Contagem por Turno
            if (turma) {
                if (turmasTarde.includes(turma)) contTarde[turma] = (contTarde[turma] || 0) + 1;
                else contManha[turma] = (contManha[turma] || 0) + 1;
            }

            // Contagem por Aluno (Ignora registros coletivos para o ranking individual)
            if (aluno && aluno !== "TODA A TURMA") {
                const chave = `${aluno} (${turma})`;
                contAlunos[chave] = (contAlunos[chave] || 0) + 1;
            }

            if (turma && aluno && aluno !== "TODA A TURMA") {
                if (!detalheTurmas[turma]) detalheTurmas[turma] = {};
                detalheTurmas[turma][aluno] = (detalheTurmas[turma][aluno] || 0) + 1;
            }

            // Extra√ß√£o do Tipo [Entre Colchetes]
            const tipoMatch = profField.match(/\[(.*?)\]/);
            const tipo = tipoMatch ? tipoMatch[1] : "OUTRO";
            
            contTipos[tipo] = (contTipos[tipo] || 0) + 1;
            contTratativas[tratativaRaw] = (contTratativas[tratativaRaw] || 0) + 1;
        }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO INTERNAS ---

        // Gr√°fico de Colunas Azuis
        const renderColunas = (obj, titulo) => {
    const entradas = Object.entries(obj).sort((a,b) => b[1] - a[1]);
    if (!entradas.length) return "";
    const max = Math.max(...Object.values(obj));
    let h = `<b style="font-size:13px; color:var(--blue); margin-left:10px;">Turno: ${titulo}</b><div class="column-chart-container">`;
    
    entradas.forEach(([t, v]) => {
        const altura = (v / max) * 100;
        // Adicionamos o onclick passando o nome da turma e os dados coletados
        h += `<div class="column-wrapper">
                <div class="column-value">${v}</div>
                <div class="column-bar" style="height:${altura}%" onclick="mostrarDetalhesTurma('${t}')"></div>
                <div class="column-label">${t}</div>
              </div>`;
    });
    return h + `</div>`;
};

        // Gr√°fico de Pizza com Legenda Zebra
        const renderPizza = (obj, titulo) => {
            const dados = Object.entries(obj).sort((a,b) => b[1] - a[1]).slice(0, 6);
            const total = Object.values(obj).reduce((a, b) => a + b, 0);
            if (total === 0) return "";
            
            let curr = 0;
            const slices = dados.map(([lab, val], idx) => {
                const p = (val / total) * 100;
                const s = `${cores[idx % cores.length]} ${curr.toFixed(2)}% ${(curr + p).toFixed(2)}%`;
                curr += p;
                return { label: lab, val: val, color: cores[idx % cores.length], slice: s };
            });

            let h = `<b style="font-size:13px; color:var(--blue);">${titulo}</b>`;
            h += `<div class="pie-chart" style="background: conic-gradient(${slices.map(s => s.slice).join(', ')})"></div>`;
            h += `<ul class="pie-legend">`;
            slices.forEach(s => {
                h += `<li><div><span class="dot" style="background:${s.color}"></span>${s.label}</div> <b>${s.val}</b></li>`;
            });
            return h + `</ul>`;
        };

        // Lista de Alunos (Tabela Zebra)
        const renderListaAlunos = (obj, limite) => {
            const ordenados = Object.entries(obj).sort((a, b) => b[1] - a[1]).slice(0, limite);
            if (!ordenados.length) return "<p style='text-align:center; color:gray;'>Nenhum dado.</p>";

            let html = '<table style="width:100%; border-collapse:collapse; font-size:12px; background:white; border-radius:8px; overflow:hidden;">';
            ordenados.forEach(([nome, total]) => {
                html += `<tr style="border-bottom: 1px solid #eee">
                            <td style="padding:10px; text-transform: uppercase;">${nome}</td>
                            <td style="padding:10px; color:red; text-align:right;"><b>${total} reg.</b></td>
                         </tr>`;
            });
            return html + '</table>';
        };

        // --- APLICA√á√ÉO DOS DADOS NOS CONTAINERS ---

        // 1. Alunos Cr√≠ticos (+10)
        const criticos = Object.entries(contAlunos).filter(a => a[1] >= 10);
        document.getElementById('resAlertaCritico').innerHTML = renderListaAlunos(Object.fromEntries(criticos), 20);

        // 2. Ocorr√™ncias por Turma (Barras)
        document.getElementById('graficoTurmas').innerHTML = renderColunas(contManha, "Manh√£") + renderColunas(contTarde, "Tarde");

        // 3. Ranking de Alunos (Lista)
        document.getElementById('listaAlunosMaisOcorrencias').innerHTML = renderListaAlunos(contAlunos, 8);

        // 4. Pizzas (Geral)
        document.getElementById('graficoPizzaTipos').innerHTML = renderPizza(contTipos, "Tipos de Registro");
        document.getElementById('graficoPizzaTratativas').innerHTML = renderPizza(contTratativas, "A√ß√µes da Gest√£o");

        window.detalheGlobal = detalheTurmas;
        
    } catch (e) { 
        console.error("Erro Dashboard:", e);
        alert("Erro ao processar os dados do Dashboard."); 
    }
}

    document.getElementById('selAluno').addEventListener('change', function() {
        if (this.value === "TODA A TURMA") { document.getElementById('boxAdvertencia').classList.add('hidden'); }
        else { ajustarCamposRegistro(); }
    });

    function ajustarCamposRegistro() {
        const t = document.getElementById('selTipoRegistro').value, a = document.getElementById('selAluno').value;
        const b = document.getElementById('boxAdvertencia');
        b.classList.toggle('hidden', t !== "üìù Ocorr√™ncia Disciplinar" || a === "TODA A TURMA");
    }

    function tab(n) {
    // 1. Bloqueio de Seguran√ßa: Se for a aba 4 e n√£o for Diretor, cancela.
    if (n === 4 && cargoLogado !== "Diretor") {
        alert("Acesso restrito √† equipe de gest√£o.");
        return;
    }

    // 2. L√≥gica de altern√¢ncia (Loop em todas as 4 abas)
    [1, 2, 3, 4].forEach(i => {
        const aba = document.getElementById('aba' + i);
        const btn = document.getElementById('t' + i);
        
        if (aba) {
            if (n === i) {
                aba.classList.remove('hidden');
            } else {
                aba.classList.add('hidden');
            }
        }
        
        if (btn) {
            btn.classList.toggle('active', n === i);
        }
    });

    // 3. Fun√ß√µes espec√≠ficas ao abrir a aba
    if (n === 4) carregarListaTransferencia();
    if (n === 1 && !idEditando) limparForm();
}
    
    function definirDataHoje() { document.getElementById('dataOcorrenciaManual').value = new Date().toISOString().split('T')[0]; }
    function limparForm() {
    // 1. Limpa os campos vis√≠veis
    document.getElementById('relatoTexto').value = "";
    document.getElementById('containerTratativa').innerHTML = "";
    document.getElementById('containerTratativa').classList.add('hidden');
    
    // 2. Reseta o controle de edi√ß√£o
    idEditando = null;
    document.getElementById('btnGravar').innerText = "Gravar no Di√°rio";
    
    // 3. LIMPA AS VARI√ÅVEIS DE MEM√ìRIA (O erro est√° aqui!)
    window.tratativaAntiga = "";
    window.relatoGestaoAntigo = "";
    window.tratativaAtual = "";      // Limpa tamb√©m as varia√ß√µes de nome
    window.relatoGestaoAtual = "";

    // 4. Reseta a data para hoje
    definirDataHoje();
    
    // 5. Volta o select de tipo para o padr√£o
    document.getElementById('selTipoRegistro').value = "üìù Ocorr√™ncia Disciplinar";
    ajustarCamposRegistro();
}
    function logout() { localStorage.removeItem('diarioAcessoSobral'); location.reload(); }
    function toggleSenha(id, ic) { const p = document.getElementById(id), i = document.getElementById(ic); p.type = p.type === "password" ? "text" : "password"; i.innerText = p.type === "password" ? "üëÅÔ∏è" : "üôà"; }
    function identificarTrimestre(ds) { 
        if(!ds) return ""; let p = ds.split('/'); let d = new Date(p[2], p[1]-1, p[0]);
        if (d >= new Date(2026, 1, 4) && d <= new Date(2026, 4, 6)) return "1¬∫ Trimestre";
        if (d >= new Date(2026, 4, 7) && d <= new Date(2026, 7, 31)) return "2¬∫ Trimestre";
        if (d >= new Date(2026, 8, 1) && d <= new Date(2026, 11, 18)) return "3¬∫ Trimestre";
    }
    async function carregarDadosIniciais() {
    try {
        const res = await fetch(`${SCRIPT_URL}?acao=getListaAlunos`);
        if (!res.ok) throw new Error("Erro na rede");
        
        ALUNOS = await res.json();
        
        // Salva no cache para uso offline
        localStorage.setItem('cache_alunos_sobral', JSON.stringify(ALUNOS));
        
        // Preenche os selects de turma na tela
        popularTurmas();
        console.log("Alunos carregados com sucesso!");
    } catch (e) {
        console.error("Erro ao buscar alunos:", e);
        // Se falhar, tenta usar o que est√° no cache do celular
        const cache = localStorage.getItem('cache_alunos_sobral');
        if (cache) {
            ALUNOS = JSON.parse(cache);
            popularTurmas();
            alert("‚ö†Ô∏è Usando lista de alunos offline (n√£o foi poss√≠vel atualizar com o servidor).");
        } else {
            alert("‚ùå Erro cr√≠tico: N√£o foi poss√≠vel carregar a lista de alunos e n√£o h√° cache dispon√≠vel.");
        }
    }
}

    function carregarListaTransferencia() {
        const selTransferir = document.getElementById('selectAlunoTransferir');
        selTransferir.innerHTML = '<option value="">Selecione o aluno...</option>';
        Object.keys(ALUNOS).sort().forEach(turma => {
            ALUNOS[turma].forEach(aluno => {
                selTransferir.add(new Option(`${aluno} (${turma})`, `${aluno}|${turma}`));
            });
        });
    }

    async function salvarNovoAluno() {
        const nome = document.getElementById('novoAlunoNome').value.trim();
        const turma = document.getElementById('novoAlunoTurma').value;
        if(!nome) return alert("Digite o nome!");
        
        const url = `${SCRIPT_URL}?acao=addAluno&nome=${encodeURIComponent(nome)}&turma=${turma}`;
        try {
            await fetch(url);
            alert("Aluno adicionado! Atualizando lista...");
            carregarDadosIniciais();
            document.getElementById('novoAlunoNome').value = "";
        } catch(e) { alert("Erro ao salvar."); }
    }

    async function transferirAluno() {
    const aluno = document.getElementById('selectAlunoTransferir').value;
    const turmaAntiga = document.getElementById('selTurmaTransf').value;
    const novaTurma = document.getElementById('novaTurmaDestino').value;

    if(!aluno || aluno === "TODA A TURMA") return alert("Selecione um aluno espec√≠fico!");
    if(turmaAntiga === novaTurma) return alert("A turma de destino deve ser diferente da atual!");

    const confirmar = confirm(`Deseja mover o aluno ${aluno} da turma ${turmaAntiga} para a ${novaTurma}?`);
    if(!confirmar) return;

    const url = `${SCRIPT_URL}?acao=transferir&aluno=${encodeURIComponent(aluno)}&turmaAntiga=${turmaAntiga}&novaTurma=${novaTurma}`;
    
    try {
        const res = await fetch(url);
        alert("Transfer√™ncia realizada com sucesso!");
        carregarDadosIniciais(); // Recarrega a lista de alunos global
    } catch(e) { 
        alert("Erro ao processar transfer√™ncia."); 
    }
}

    function mostrarDetalhesTurma(turma) {
    const container = document.getElementById('detalheAlunosTurma');
    // window.dadosDetalhados deve ser alimentado na gerarAlertaCritico
    const alunos = window.detalheGlobal[turma]; 

    if (!alunos) {
        alert("Nenhum detalhe individual para esta turma.");
        return;
    }

    const listaOrdenada = Object.entries(alunos).sort((a, b) => b[1] - a[1]);
    
    let html = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; color:var(--blue);">Alunos com Ocorr√™ncia: Turma ${turma}</h4>
                    <button onclick="document.getElementById('detalheAlunosTurma').classList.add('hidden')" style="border:none; background:none; cursor:pointer; font-weight:bold; color:red;">[ Fechar ]</button>
                </div>`;
    
    html += '<table style="width:100%; border-collapse:collapse; font-size:12px;">';
    listaOrdenada.forEach(([nome, total]) => {
        html += `<tr style="border-bottom:1px solid #eee;">
                    <td style="padding:8px; text-transform:uppercase;">${nome}</td>
                    <td style="padding:8px; text-align:right;"><b>${total}</b></td>
                 </tr>`;
    });
    html += '</table>';

    container.innerHTML = html;
    container.classList.remove('hidden');
    container.scrollIntoView({ behavior: 'smooth' });
}
</script>

</body>
</html>
















