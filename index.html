<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d47a1">
    <title>Di√°rio de Bordo - E. M. Sobral Pinto</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="./icon-512.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#0d47a1">

    <style>
        :root { --blue: #0d47a1; --gold: #ffd600; --glass: rgba(255, 255, 255, 0.95); }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1497633762265-9d179a990aa6?q=80') center/cover fixed; min-height: 100vh; }
        
        #status-bar { width: 100%; padding: 10px; text-align: center; font-size: 14px; font-weight: bold; color: white; position: sticky; top: 0; z-index: 10001; transition: background 0.5s ease; display: none; }
        header { background: var(--blue); color: white; padding: 15px 3%; display: flex; align-items: center; justify-content: space-between; border-bottom: 4px solid var(--gold); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .img-topo { width: 80px; height: 80px; object-fit: contain; background: white; border-radius: 50%; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .escola-txt { text-align: center; flex-grow: 1; padding: 0 15px; }
        .escola-txt h1 { margin: 0; font-size: 20px; text-transform: uppercase; }
        .escola-txt p { margin: 5px 0 0; font-size: 12px; opacity: 0.9; line-height: 1.4; }
        .container { max-width: 650px; margin: 20px auto; padding: 15px; }
        .tabs { display: flex; background: rgba(255,255,255,0.2); border-radius: 12px 12px 0 0; backdrop-filter: blur(10px); padding: 5px 5px 0; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: white; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0; }
        .tab-btn.active { background: var(--glass); color: var(--blue); }
        .card { background: var(--glass); padding: 25px; border-radius: 0 0 12px 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .hidden { display: none !important; }
        label { display: block; margin-top: 15px; font-weight: bold; color: #333; }
        input, select, textarea, .btn-main { width: 100%; padding: 12px; margin-top: 8px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        .btn-main { background: var(--blue); color: white; font-weight: bold; cursor: pointer; border: none; padding: 12px; border-radius: 8px; width: 100%; transition: 0.3s; }
        
        .auth-wrapper { display: flex; justify-content: center; align-items: center; min-height: 70vh; padding: 20px; }
        .box-auth { background: var(--glass); padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); width: 100%; max-width: 350px; text-align: center; backdrop-filter: blur(10px); }
        .box-auth input { margin-bottom: 15px; border: 1px solid #ddd; width: 100%; }
        
        .filtro-item { display: flex; align-items: center; cursor: pointer; font-size: 14px; margin-bottom: 12px; padding: 5px; border-radius: 4px; transition: background 0.2s; }
        .filtro-item input { width: 20px; height: 20px; margin: 0 12px 0 0; cursor: pointer; flex-shrink: 0; }
        
        .column-chart-container { display: flex; align-items: flex-end; justify-content: space-around; height: 180px; padding: 20px 10px; border-bottom: 2px solid #ddd; margin-bottom: 40px; background: rgba(255,255,255,0.5); border-radius: 8px; }
        .column-bar { background: var(--blue); width: 25px; border-radius: 4px 4px 0 0; transition: all 0.5s ease; border: 1px solid rgba(0,0,0,0.1); }
        .pie-charts-wrapper { display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px; margin-bottom: 20px; }
        .pie-chart { width: 140px; height: 140px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: 10px 0; }
        
        .titulo-trimestre { background: var(--gold); color: #000; padding: 8px 15px; margin-top: 25px; border-radius: 6px; font-weight: bold; border-left: 10px solid var(--blue); }
        .item-ocorrencia { background: white; padding: 15px; border-left: 5px solid var(--blue); margin-top: 10px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        .btn-ajuda-fixo { position: fixed; bottom: 20px; right: 20px; background: #25d366; color: white; padding: 10px 20px; border-radius: 30px; border: none; font-weight: bold; z-index: 9999; cursor: pointer; }
        .modal-ajuda { position: fixed; bottom: 90px; right: 20px; width: 280px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 9999; }
    </style>
</head>

<body>

<div id="status-bar">Aguardando status da rede...</div>

<header>
    <img src="https://lh3.googleusercontent.com/u/0/d/16JafsMd81Ho26kkaqCI-YTvsCGIXQ2Fy" alt="Perfil" class="img-topo" id="imgPerfil">
    <div class="escola-txt">
        <h1>Escola Municipal Sobral Pinto</h1>
        <p>Rua das Almas, 120 - Conjunto Paulo VI, Belo Horizonte - MG.<br>CEP: 31998-020</p>
    </div>
</header>

<div id="secaoAcesso" class="auth-wrapper">
    <div id="telaLogin" class="box-auth">
        <h2 style="color:var(--blue)">üîí Login</h2>
        <input type="text" id="userLogin" placeholder="Usu√°rio">
        <div class="senha-container" style="position:relative;">
            <input type="password" id="passLogin" placeholder="Senha">
            <button type="button" class="btn-olho" style="position:absolute; right:10px; top:12px; border:none; background:none; cursor:pointer;" onclick="toggleSenha('passLogin', 'iconeOlho')">
                <span id="iconeOlho">üëÅÔ∏è</span>
            </button>
        </div>
        <button class="btn-main" id="btnEntrar" onclick="executarLogin()">Entrar</button>
        <button style="background:none; border:none; color:var(--blue); cursor:pointer; margin-top:10px;" onclick="irPara('telaRecuperar')">Alterar senha</button>
    </div>

    <div id="telaRecuperar" class="box-auth hidden">
        <h2 style="color:var(--blue)">üîë Recuperar</h2>
        <input type="text" id="recNome" placeholder="Nome Completo">
        <input type="text" id="recBM" placeholder="BM">
        <input type="password" id="recNovaPass" placeholder="Nova Senha">
        <button class="btn-main" onclick="executarRecuperacao()">Alterar Senha</button>
        <button style="background:none; border:none; color:var(--blue); cursor:pointer; margin-top:10px;" onclick="irPara('telaLogin')">Voltar</button>
    </div>
</div>

<div id="conteudoDiario" class="container hidden">
    <div class="tabs">
        <button id="t1" class="tab-btn active" onclick="tab(1)">üìù INCLUIR</button>
        <button id="t2" class="tab-btn" onclick="tab(2)">üîç CONSULTAR</button>
        <button id="t3" class="tab-btn" onclick="tab(3)">üìä ALERTAS</button>
        <button onclick="logout()" style="background:none; color:white; flex:0.3; cursor:pointer">Sair</button>
    </div>
    <div class="card">
        <div id="aba1">
            <div id="tipoRegistroContainer" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd;">
                <label style="margin-top:0;">Tipo de Registro:</label>
                <select id="selTipoRegistro" onchange="ajustarCamposRegistro()">
                    <option value="üìù Ocorr√™ncia Disciplinar">üìù Ocorr√™ncia Disciplinar</option>
                    <option value="üë™ Reuni√£o com a Fam√≠lia">üë™ Reuni√£o com a Fam√≠lia</option>
                    <option value="üè• Sa√∫de (Doente / Machucou)">üè• Sa√∫de (Doente / Machucou)</option>
                    <option value="üß† Equipe PAS">üß† Equipe PAS</option>
                    <option value="üìé Outros Atendimentos">üìé Outros Atendimentos</option>
                </select>
            </div>
            <label>Respons√°vel:</label>
            <input type="text" id="nomeProfLogado" readonly style="background:#e9ecef">
            <label>Data:</label>
            <input type="date" id="dataOcorrenciaManual">
            <label>Turma:</label>
            <select id="selTurma" onchange="atualizarAlunos('selTurma', 'selAluno')"><option value="">Carregando...</option></select>
            <label>Aluno:</label>
            <select id="selAluno"><option value="">Selecione a turma...</option></select>
            
            <div id="boxAdvertencia">
                <label style="display: flex; align-items: center; cursor: pointer; background: #fff3cd; padding: 10px; border-radius: 8px; border: 1px solid #ffeeba; margin-top: 15px;">
                    <input type="checkbox" id="chkAdvertencia" style="width: auto; margin: 0 10px 0 0;"> 
                    <span>Foi enviada Advert√™ncia por Escrito?</span>
                </label>
            </div>

            <label id="labelRelato">Relato do Professor:</label>
            <textarea id="relatoTexto" rows="5"></textarea>
            <div id="containerTratativa"></div>
            <button class="btn-main" id="btnGravar" onclick="gravarOcorrencia()">Gravar no Di√°rio</button>
        </div>

        <div id="aba2" class="hidden">
            <select id="selTurmaCons" onchange="atualizarAlunos('selTurmaCons', 'selAlunoCons')"><option value="">Turma...</option></select>
            <select id="selAlunoCons" style="margin-top:10px;"><option value="">Aluno...</option></select>
            <select id="selPeriodoCons" style="margin-top:10px;">
                <option value="Todos os Trimestres">Todos os Trimestres</option>
                <option value="1¬∫ Trimestre">1¬∫ Trimestre</option>
                <option value="2¬∫ Trimestre">2¬∫ Trimestre</option>
                <option value="3¬∫ Trimestre">3¬∫ Trimestre</option>
            </select>
            <div class="filtro-box">
                <label class="filtro-item"><input type="checkbox" id="chkMeusRegistros" checked onclick="alternarCheckboxes('meu')"> <span>Apenas meus registros</span></label>
                <label class="filtro-item"><input type="checkbox" id="chkTodosRegistros" onclick="alternarCheckboxes('todos')"> <span>Todas as ocorr√™ncias</span></label>
            </div>
            <button class="btn-main" onclick="consultarHistorico()">üîç Buscar Hist√≥rico</button>
            <div id="resConsulta"></div>
            <button class="btn-main" id="btnImp" style="background:#444; display:none; margin-top:20px" onclick="window.print()">üñ®Ô∏è PDF / Imprimir</button>
        </div>

        <div id="aba3" class="hidden">
            <h2 style="color:var(--blue); margin-top:0;">üìä Controle Geral</h2>
            <button class="btn-main" onclick="gerarAlertaCritico()">üîÑ Atualizar dashboard</button>
            <div id="resDashboard" class="hidden">
                <div class="dashboard-title">Alunos Cr√≠ticos (+10)</div>
                <div id="resAlertaCritico"></div>
                <div class="dashboard-title">Ocorr√™ncias por Turma</div>
                <div id="graficoTurmas"></div>
                <div class="pie-charts-wrapper">
                    <div id="graficoPizzaTipos" class="pie-container"></div>
                    <div id="graficoPizzaTratativas" class="pie-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwlVbz3C-bdKUbRvuWx4SrL9eiFdmyRwwZwUYVhi9u8u2df9NSgNRNjsYx7gD5q1qef7g/exec";
    let ALUNOS = {};
    let cargoLogado = "", profNomeLogado = "", disciplinaLogada = "", idEditando = null;

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').then(reg => console.log('SW OK'), err => console.log('Erro SW'));
        });
    }

    window.onload = function() {
        window.NOME_ESCOLA = "E. M. Sobral Pinto";
        const cacheAlunos = localStorage.getItem('cache_alunos_sobral');
        if (cacheAlunos) { ALUNOS = JSON.parse(cacheAlunos); popularTurmas(); }

        const salvo = localStorage.getItem('diarioAcessoSobral');
        if (salvo) { aplicarLogin(JSON.parse(salvo)); }

        if (navigator.onLine) { sincronizarDados(); carregarDadosIniciais(); }
        atualizarStatusRede();
    };

    function atualizarStatusRede() {
        const barra = document.getElementById('status-bar');
        if (navigator.onLine) {
            barra.textContent = "‚úÖ Voc√™ est√° Online";
            barra.style.background = "#4caf50";
            barra.style.display = "block";
            sincronizarDados();
            setTimeout(() => barra.style.display = "none", 3000);
        } else {
            barra.textContent = "‚ö†Ô∏è Offline. Registros salvos no celular.";
            barra.style.background = "#ff9800";
            barra.style.display = "block";
        }
    }

    function alternarCheckboxes(quem) {
    const cMeu = document.getElementById('chkMeusRegistros');
    const cTodos = document.getElementById('chkTodosRegistros');

    if (quem === 'meu') {
        // Se marcou "Meus", desmarca o "Todos"
        if (cMeu.checked) {
            cTodos.checked = false;
        } else {
            // Impede desmarcar os dois: se tentou desmarcar "Meus", ele volta a marcar
            cMeu.checked = true;
        }
    } else if (quem === 'todos') {
        // Se marcou "Todos", desmarca o "Meus"
        if (cTodos.checked) {
            cMeu.checked = false;
        } else {
            // Impede desmarcar os dois
            cTodos.checked = true;
        }
    }

    // Se houver uma consulta ativa na tela, atualiza os resultados automaticamente
    if (document.getElementById('resConsulta').innerHTML !== "" && 
        document.getElementById('resConsulta').innerHTML !== "Buscando...") {
        consultarHistorico();
    }
}
    
    window.addEventListener('online', atualizarStatusRede);
    window.addEventListener('offline', atualizarStatusRede);

    async function executarLogin() {
        const u = document.getElementById('userLogin').value, s = document.getElementById('passLogin').value;
        const btn = document.getElementById('btnEntrar');
        btn.innerText = "‚è≥...";
        try {
            const res = await fetch(`${SCRIPT_URL}?acao=login&usuario=${u}&senha=${s}`);
            const d = await res.json();
            if(d.status === "Autorizado") {
                localStorage.setItem('diarioAcessoSobral', JSON.stringify(d)); 
                aplicarLogin(d);
            } else alert("Negado.");
        } catch (e) { alert("Erro de conex√£o."); }
        btn.innerText = "Entrar";
    }

    function aplicarLogin(d) {
        profNomeLogado = d.nome;
        disciplinaLogada = d.disciplina;
        const cp = String(d.cargo).trim().toUpperCase();
        const gestores = ["DIRETOR", "DIRETORA", "VICE-DIRETOR", "VICE-DIRETORA", "COORDENADOR", "COORDENADORA", "SUPERVISOR", "SUPERVISORA", "PAS"];
        cargoLogado = gestores.some(c => cp.includes(c)) ? "Diretor" : "Professor";
        document.getElementById('secaoAcesso').classList.add('hidden');
        document.getElementById('conteudoDiario').classList.remove('hidden');
        document.getElementById('nomeProfLogado').value = profNomeLogado;
        definirDataHoje(); popularTurmas(); ajustarCamposRegistro();
    }

    function popularTurmas() {
        const selects = [document.getElementById('selTurma'), document.getElementById('selTurmaCons')];
        const turmas = Object.keys(ALUNOS).sort();
        selects.forEach(sel => {
            sel.innerHTML = '<option value="">Turma...</option>';
            turmas.forEach(t => sel.add(new Option(t, t)));
        });
    }

    function atualizarAlunos(idT, idA) {
        const t = document.getElementById(idT).value, s = document.getElementById(idA);
        s.innerHTML = '<option value="">-- Selecione --</option>';
        if(ALUNOS[t]) {
            s.add(new Option("üë• TODA A TURMA", "TODA A TURMA"));
            ALUNOS[t].forEach(al => s.add(new Option(al, al)));
        }
    }

    async function gravarOcorrencia() {
    const tVal = document.getElementById('selTurma').value;
    const aVal = document.getElementById('selAluno').value;
    const rVal = document.getElementById('relatoTexto').value;
    const dVal = document.getElementById('dataOcorrenciaManual').value;

    if (!dVal || !tVal || !aVal || !rVal.trim()) {
        return alert("‚ö†Ô∏è Preencha Data, Turma, Aluno e Relato!");
    }

    // --- NOVA L√ìGICA PARA CAPTURAR TRATATIVA E DATA ---
    let tratativaFinal = "";
    let relatoGestaoFinal = "";

    if (cargoLogado === "Diretor") {
        const selT = document.getElementById('selTratativa');
        const dtC = document.getElementById('dataConvocacao');
        const rG = document.getElementById('relatoGestaoTexto');

        if (selT && selT.value) {
            tratativaFinal = selT.value;
            // Se for Fam√≠lia Convocada, anexa a data ao texto da tratativa
            if (tratativaFinal === "Fam√≠lia Convocada" && dtC && dtC.value) {
                const dataFormatada = dtC.value.split('-').reverse().join('/');
                tratativaFinal += ` (Data: ${dataFormatada})`;
            }
        }
        if (rG) relatoGestaoFinal = rG.value;
    }
    // --------------------------------------------------

    const dados = {
        acao: idEditando ? 'editarOcorrencia' : 'salvarOcorrencia',
        id: idEditando || Date.now(),
        professor: `[${document.getElementById('selTipoRegistro').value}] Prof: ${profNomeLogado.split(" ")[0]}`,
        dataManual: dVal.split("-").reverse().join("/"),
        turma: tVal,
        aluno: aVal,
        texto: rVal,
        advertencia: document.getElementById('chkAdvertencia').checked ? "SIM" : "N√ÉO",
        tratativa: tratativaFinal, // Agora envia com a data inclusa
        relatoGestao: relatoGestaoFinal
    };

    const btn = document.getElementById('btnGravar');
    btn.innerText = "‚è≥ Gravando...";
    btn.disabled = true;

    if (navigator.onLine) {
        try {
            const p = new URLSearchParams();
            for (let key in dados) p.append(key, dados[key]);
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
            alert("Sucesso!");
            limparForm();
        } catch (e) { salvarFila(dados); }
    } else {
        salvarFila(dados);
    }
    btn.innerText = "Gravar no Di√°rio";
    btn.disabled = false;
}

    function salvarFila(d) {
        let f = JSON.parse(localStorage.getItem('filaOfflineSobral') || "[]");
        f.push(d); localStorage.setItem('filaOfflineSobral', JSON.stringify(f));
        alert("Salvo offline!"); limparForm();
    }

    async function sincronizarDados() {
        let f = JSON.parse(localStorage.getItem('filaOfflineSobral') || "[]");
        if (f.length > 0 && navigator.onLine) {
            for (let item of f) {
                const p = new URLSearchParams(); for (let k in item) p.append(k, item[k]);
                try { await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p }); } catch(e){}
            }
            localStorage.removeItem('filaOfflineSobral'); alert("Sincronizado!");
        }
    }

    async function consultarHistorico() {
        const t = document.getElementById('selTurmaCons').value, a = document.getElementById('selAlunoCons').value;
        if (!t) return alert("Selecione a Turma.");
        const rDiv = document.getElementById('resConsulta'); rDiv.innerHTML = "Buscando...";
        try {
            const res = await fetch(`${SCRIPT_URL}?acao=getDados`);
            const data = await res.json();
            exibirDados(data, t, a, document.getElementById('selPeriodoCons').value);
        } catch (e) { rDiv.innerHTML = "Erro."; }
    }

    function exibirDados(data, t, a, p) {
    const rDiv = document.getElementById('resConsulta');
    const verTodos = document.getElementById('chkTodosRegistros').checked;
    
    // 1. Filtragem por Turma e Aluno
    let filtrados = data.filter(r => {
        const turmaBate = r[3] && String(r[3]).trim() === t;
        const alunoBate = a ? (String(r[4]).trim() === a) : (String(r[4]).trim() === "TODA A TURMA");
        return turmaBate && alunoBate;
    });

    // 2. Filtros de Trimestre e Dono do Registro
    if (p !== "Todos os Trimestres") filtrados = filtrados.filter(r => identificarTrimestre(r[1]) === p);
    if (!verTodos) {
        const meuNome = profNomeLogado.split(" ")[0].toUpperCase();
        filtrados = filtrados.filter(r => String(r[2]).toUpperCase().includes(meuNome));
    }

    // 3. Ordena√ß√£o (Mais recente primeiro)
    filtrados.sort((m, n) => {
        const c = (t) => { let x = t.split('/'); return new Date(x[2], x[1]-1, x[0]); };
        return c(n[1]) - c(m[1]);
    });

    if (filtrados.length === 0) { rDiv.innerHTML = "<p style='text-align:center; padding:20px;'>Nada encontrado.</p>"; return; }
    
    let html = `<h3>Hist√≥rico: ${a || "Toda a Turma " + t}</h3>`;
    let grupos = { "1¬∫ Trimestre": [], "2¬∫ Trimestre": [], "3¬∫ Trimestre": [], "Fora de Per√≠odo": [] };
    filtrados.forEach(r => { let tri = identificarTrimestre(r[1]); if(grupos[tri]) grupos[tri].push(r); else grupos["Fora de Per√≠odo"].push(r); });

    for (let tri in grupos) {
        if (grupos[tri].length > 0) {
            html += `<div class="titulo-trimestre">${tri}</div>`;
            grupos[tri].forEach(r => {
                const souDono = String(r[2]).toUpperCase().includes(profNomeLogado.split(" ")[0].toUpperCase());
                const souGestor = (cargoLogado === "Diretor");

                // --- L√ìGICA DE EXIBI√á√ÉO DA TRATATIVA ---
                let textoTratativa = r[7] || "";
                let avisoDataReuniao = "";

                // Se houver data de reuni√£o no texto da tratativa, ela deve aparecer para TODOS
                if (textoTratativa.includes("(Data:")) {
                    const matchData = textoTratativa.match(/\d{2}\/\d{2}\/\d{4}/);
                    if (matchData) {
                        avisoDataReuniao = `<p style="color:#e65100; font-weight:bold; margin-top:5px;">üìÖ Reuni√£o agendada para: ${matchData[0]}</p>`;
                    }
                }

                // Relato Privado: Aparece apenas se for Gestor
                const relatoPrivadoHTML = (souGestor && r[8]) ? 
                    `<div style="background:#fff3e0; padding:10px; border:1px dashed #ff9800; margin-top:8px; font-size:12px; color:#e65100;">
                        <strong>üîí Relato Privado (Gest√£o):</strong> ${r[8]}
                    </div>` : "";

                html += `<div class="item-ocorrencia">
                    <div style="float:right; display:flex; gap:5px;">
                        ${(souDono || souGestor) ? `<button onclick="carregarParaEdicao('${r[0]}','${r[1]}','${r[3]}','${r[4]}','${r[5]}','${r[7]||""}','${r[8]||""}', false)" style="background:orange; color:white; border:none; padding:5px; border-radius:4px; cursor:pointer;">Editar</button>` : ''}
                        ${souGestor ? `
                            <button onclick="carregarParaEdicao('${r[0]}','${r[1]}','${r[3]}','${r[4]}','${r[5]}','${r[7]||""}','${r[8]||""}', true)" style="background:#1976d2; color:white; border:none; padding:5px; border-radius:4px; cursor:pointer;">Tratar</button>
                            <button onclick="apagarRegistro('${r[0]}')" style="background:red; color:white; border:none; padding:5px 8px; border-radius:4px; cursor:pointer;">X</button>
                        ` : ''}
                    </div>
                    <strong>${r[1]} - ${r[2]}</strong>
                    <p style="margin:10px 0;">${r[5]}</p>
                    ${r[6] === "SIM" ? '<p style="color:red; font-weight:bold;">‚ö†Ô∏è Advert√™ncia por Escrito Enviada</p>' : ''}
                    ${textoTratativa ? `<div style="background:#e8f5e9; padding:10px; border-left:4px solid #4caf50; font-size:13px;"><strong>A√ß√£o da Gest√£o:</strong> ${textoTratativa} ${avisoDataReuniao}</div>` : ''}
                    ${relatoPrivadoHTML}
                </div>`;
            });
        }
    }
    rDiv.innerHTML = html;
    document.getElementById('btnImp').style.display = "block";
}

    function carregarParaEdicao(id, data, turma, aluno, texto, tratativa, relatoGestao, focarTratativa) {
    idEditando = id; 
    tab(1); 
    
    // Ajuste da data principal
    const p = data.split('/');
    if(p.length === 3) document.getElementById('dataOcorrenciaManual').value = `${p[2]}-${p[1]}-${p[0]}`;
    
    document.getElementById('selTurma').value = turma;
    atualizarAlunos('selTurma', 'selAluno');
    
    setTimeout(() => {
        document.getElementById('selAluno').value = aluno;
    }, 200);
    
    document.getElementById('relatoTexto').value = texto;

    const cont = document.getElementById('containerTratativa');
    
    if (cargoLogado === "Diretor" && focarTratativa === true) {
        // Extra√ß√£o precisa da data da convoca√ß√£o
        let opcaoLimpa = tratativa.split(" (Data:")[0].trim();
        let dataParaInput = "";
        
        if (tratativa.includes("(Data:")) {
            const extrair = tratativa.match(/\d{2}\/\d{2}\/\d{4}/);
            if (extrair) {
                dataParaInput = extrair[0].split('/').reverse().join('-');
            }
        }

        cont.innerHTML = `
            <div style="background:#f0f7ff; padding:15px; border-radius:8px; margin-top:15px; border:1px solid #1976d2;">
                <label style="color:#1976d2; font-weight:bold;">üõ†Ô∏è Espa√ßo da Gest√£o (Tratativa)</label>
                
                <select id="selTratativa" onchange="verificarDataConvocacao()" style="width:100%; margin-top:8px;">
                    <option value="">Selecione a a√ß√£o...</option>
                    <option value="Conversa com o Aluno">Conversa com o Aluno</option>
                    <option value="Advert√™ncia Verbal">Advert√™ncia Verbal</option>
                    <option value="Advert√™ncia por Escrito">Advert√™ncia por Escrito</option>
                    <option value="Fam√≠lia Convocada">Fam√≠lia Convocada</option>
                    <option value="Encaminhamento PAS">Encaminhamento PAS</option>
                </select>

                <div id="divDataConvocacao" style="display:none; margin-top:10px;">
                    <label>üìÖ Data da Reuni√£o:</label>
                    <input type="date" id="dataConvocacao" style="width:100%;">
                </div>

                <label style="display:block; margin-top:15px;">üîí Relato Interno (Privado):</label>
                <textarea id="relatoGestaoTexto" rows="3" style="width:100%;" placeholder="Anota√ß√µes da gest√£o..."></textarea>
            </div>`;
        
        cont.classList.remove('hidden');

        // IMPORTANTE: Atribuir valores AP√ìS criar o HTML acima
        setTimeout(() => {
            document.getElementById('selTratativa').value = opcaoLimpa;
            document.getElementById('relatoGestaoTexto').value = relatoGestao || "";
            
            if (opcaoLimpa === "Fam√≠lia Convocada") {
                document.getElementById('divDataConvocacao').style.display = 'block';
                document.getElementById('dataConvocacao').value = dataParaInput;
            }
            document.getElementById('selTratativa').focus();
        }, 50);

    } else {
        cont.innerHTML = "";
        cont.classList.add('hidden');
    }
    document.getElementById('btnGravar').innerText = "üíæ Salvar Altera√ß√£o";
}

    async function apagarRegistro(id) {
    // 1. A exclus√£o √© uma a√ß√£o cr√≠tica, por isso exige internet para atualizar o banco de dados
    if (!navigator.onLine) {
        return alert("‚ö†Ô∏è A exclus√£o de registros exige conex√£o com a internet para atualizar o banco de dados da escola.");
    }

    // 2. Confirma√ß√£o de seguran√ßa para evitar cliques acidentais
    if (!confirm("Tem certeza que deseja excluir este registro definitivamente? Esta a√ß√£o n√£o pode ser desfeita.")) {
        return;
    }

    const btn = event.target; // Captura o bot√£o clicado
    const textoOriginal = btn.innerText;
    btn.innerText = "‚è≥...";
    btn.disabled = true;

    try {
        const p = new URLSearchParams();
        p.append('acao', 'apagarOcorrencia');
        p.append('id', id);

        // Envia o pedido para o SCRIPT_URL definido no topo do c√≥digo
        const res = await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: p });
        
        alert("Registro exclu√≠do com sucesso!");
        
        // Atualiza a lista na tela para o registro sumir imediatamente
        consultarHistorico(); 
    } catch (e) {
        console.error("Erro ao excluir:", e);
        alert("Ocorreu um erro ao tentar excluir o registro no servidor.");
        btn.innerText = textoOriginal;
        btn.disabled = false;
    }
}
    
    function verificarDataConvocacao() {
    const sel = document.getElementById('selTratativa');
    const div = document.getElementById('divDataConvocacao');
    if (sel && div) {
        div.style.display = (sel.value === "Fam√≠lia Convocada") ? "block" : "none";
    }
}

    async function gerarAlertaCritico() {
        if (!navigator.onLine) return alert("Offline!");
        document.getElementById('resDashboard').classList.remove('hidden');
        try {
            const res = await fetch(`${SCRIPT_URL}?acao=getDados`);
            const data = await res.json();
            let contAlunos = {}, contTipos = {};
            for (let i = 1; i < data.length; i++) {
                let a = data[i][4], t = data[i][2] || "";
                if (a) contAlunos[a] = (contAlunos[a] || 0) + 1;
                let m = t.match(/\[(.*?)\]/); let tp = m ? m[1] : "OUTRO";
                contTipos[tp] = (contTipos[tp] || 0) + 1;
            }
            // (L√≥gica simplificada para exemplo, gr√°ficos exigem biblioteca ou conic-gradient CSS manual)
            document.getElementById('resAlertaCritico').innerHTML = "Dashboard carregado. Veja console para detalhes.";
            console.log(contAlunos, contTipos);
        } catch(e) { alert("Erro dashboard"); }
    }

    document.getElementById('selAluno').addEventListener('change', function() {
        if (this.value === "TODA A TURMA") { document.getElementById('boxAdvertencia').classList.add('hidden'); }
        else { ajustarCamposRegistro(); }
    });

    function ajustarCamposRegistro() {
        const t = document.getElementById('selTipoRegistro').value, a = document.getElementById('selAluno').value;
        const b = document.getElementById('boxAdvertencia');
        b.classList.toggle('hidden', t !== "üìù Ocorr√™ncia Disciplinar" || a === "TODA A TURMA");
    }

    function tab(n) { [1,2,3].forEach(i => { document.getElementById('aba'+i).classList.toggle('hidden', n !== i); document.getElementById('t'+i).classList.toggle('active', n === i); }); }
    function definirDataHoje() { document.getElementById('dataOcorrenciaManual').value = new Date().toISOString().split('T')[0]; }
    function limparForm() { document.getElementById('relatoTexto').value = ""; idEditando = null; document.getElementById('btnGravar').innerText = "Gravar"; definirDataHoje(); document.getElementById('containerTratativa').innerHTML = ""; }
    function logout() { localStorage.removeItem('diarioAcessoSobral'); location.reload(); }
    function toggleSenha(id, ic) { const p = document.getElementById(id), i = document.getElementById(ic); p.type = p.type === "password" ? "text" : "password"; i.innerText = p.type === "password" ? "üëÅÔ∏è" : "üôà"; }
    function identificarTrimestre(ds) { 
        if(!ds) return ""; let p = ds.split('/'); let d = new Date(p[2], p[1]-1, p[0]);
        if (d >= new Date(2026, 1, 4) && d <= new Date(2026, 4, 15)) return "1¬∫ Trimestre";
        if (d >= new Date(2026, 4, 18) && d <= new Date(2026, 7, 31)) return "2¬∫ Trimestre";
        return "3¬∫ Trimestre";
    }
    async function carregarDadosIniciais() {
        try { const res = await fetch(`${SCRIPT_URL}?acao=getListaAlunos`); ALUNOS = await res.json(); localStorage.setItem('cache_alunos_sobral', JSON.stringify(ALUNOS)); popularTurmas(); } catch(e){}
    }
</script>

</body>
</html>











